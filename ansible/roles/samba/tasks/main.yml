---
- name: Validate Samba configuration
  assert:
    that:
      - samba_username is defined and samba_username | length > 0
      - vault_samba_password is defined and vault_samba_password | length > 0
      - samba_shares is defined and samba_shares | length > 0
    fail_msg: "Invalid Samba configuration - missing required variables"

- name: Install Samba packages
  apt:
    name:
      - samba
      - samba-common-bin
    state: present
    update_cache: yes
  become: true

- name: Create shared directories
  file:
    path: "{{ item.path }}"
    state: directory
    mode: '0755'
    owner: "{{ samba_username }}"
    group: "{{ samba_username }}"
  become: true
  loop: "{{ samba_shares }}"

- name: Create samba configuration from template
  template:
    src: smb.conf.j2
    dest: /etc/samba/smb.conf
    backup: yes
    mode: '0644'
    owner: root
    group: root
  become: true
  notify: restart samba

- name: Check if Samba user exists
  shell: pdbedit -L | grep "^{{ samba_username }}:"
  register: samba_user_exists
  failed_when: false
  changed_when: false
  become: true

- name: Add samba user
  shell: |
    (echo "{{ vault_samba_password }}"; echo "{{ vault_samba_password }}") | smbpasswd -s -a {{ samba_username }}
  become: true
  when: samba_user_exists.rc != 0
  no_log: true

- name: Enable samba user
  shell: smbpasswd -e {{ samba_username }}
  become: true
  when: samba_user_exists.rc != 0
  register: enable_result
  failed_when: enable_result.rc != 0

- name: Update samba user password
  shell: |
    (echo "{{ vault_samba_password }}"; echo "{{ vault_samba_password }}") | smbpasswd -s {{ samba_username }}
  become: true
  when: samba_user_exists.rc == 0
  no_log: true
  tags: samba_password

- name: Start and enable samba services
  systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
  become: true
  loop:
    - smbd
    - nmbd

- name: Check if UFW is installed and active
  command: ufw status
  register: ufw_status
  failed_when: false
  changed_when: false
  become: true

- name: Allow Samba through firewall
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Samba SMB"
  become: true
  loop:
    - "139"
    - "445"
  when: 
    - ufw_status.rc == 0
    - "'Status: active' in ufw_status.stdout"
  register: samba_tcp_firewall
  failed_when: samba_tcp_firewall.failed and 'Could not update rules' not in samba_tcp_firewall.msg

- name: Allow NetBIOS through firewall
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: udp
    comment: "Samba NetBIOS"
  become: true
  loop:
    - "137"
    - "138"
  when: 
    - ufw_status.rc == 0
    - "'Status: active' in ufw_status.stdout"
  register: samba_udp_firewall
  failed_when: samba_udp_firewall.failed and 'Could not update rules' not in samba_udp_firewall.msg