---
- name: Validate data SSD configuration
  assert:
    that:
      - (data_ssd_device is defined and data_ssd_device | length > 0) or (data_ssd_serial is defined and data_ssd_serial | length > 0)
      - data_ssd_mount_point is defined and data_ssd_mount_point.startswith('/')
      - data_ssd_filesystem is defined
    fail_msg: "Invalid data SSD configuration. Either data_ssd_device or data_ssd_serial must be set in inventory"

- name: Find device by serial number
  shell: |
    lsblk -ndo NAME,SERIAL | grep '{{ data_ssd_serial }}' | awk '{print "/dev/" $1}'
  register: device_by_serial
  changed_when: false
  when: data_ssd_serial is defined
  failed_when:
    - device_by_serial.rc != 0 or device_by_serial.stdout | length == 0

- name: Set device path from serial lookup
  set_fact:
    data_ssd_device: "{{ device_by_serial.stdout | trim }}"
  when: data_ssd_serial is defined

- name: Display identified device
  debug:
    msg: "Using device: {{ data_ssd_device }}{{ ' (identified by serial: ' + data_ssd_serial + ')' if data_ssd_serial is defined else '' }}"

- name: Verify target device exists and is block device
  stat:
    path: "{{ data_ssd_device }}"
  register: ssd_device_stat
  failed_when: not ssd_device_stat.stat.exists or not ssd_device_stat.stat.isblk

- name: Check if device already has a filesystem
  command: blkid {{ data_ssd_device }}
  register: existing_filesystem
  failed_when: false
  changed_when: false

- name: Display existing filesystem warning
  debug:
    msg: "WARNING: Device {{ data_ssd_device }} already has a filesystem. Use data_ssd_force_format=true to overwrite."
  when: existing_filesystem.rc == 0 and not data_ssd_force_format

- name: Create ext4 filesystem on SSD
  filesystem:
    fstype: "{{ data_ssd_filesystem }}"
    dev: "{{ data_ssd_device }}"
    opts: "{{ data_ssd_mkfs_options | join(' ') }}"
    force: "{{ data_ssd_force_format }}"
  become: true
  when: existing_filesystem.rc != 0 or data_ssd_force_format

- name: Create mount point directory
  file:
    path: "{{ data_ssd_mount_point }}"
    state: directory
    mode: '0755'
  become: true

- name: Get UUID of the SSD device
  command: blkid -s UUID -o value {{ data_ssd_device }}
  register: ssd_uuid
  changed_when: false
  become: true

- name: Display device UUID information
  debug:
    msg: "Device {{ data_ssd_device }} UUID: {{ ssd_uuid.stdout | default('(empty)') }}"

- name: Validate UUID is not empty
  assert:
    that:
      - ssd_uuid.stdout is defined
      - ssd_uuid.stdout | length > 0
    fail_msg: |
      Device {{ data_ssd_device }} does not have a UUID. This usually means:
      1. The filesystem creation was skipped because the device appears to have a filesystem
      2. But that filesystem doesn't have a valid UUID

      To fix this, either:
      - Set data_ssd_force_format=true to force recreation of the filesystem
      - Manually format the device on the target system
      - Check if the device is the correct one

- name: Mount the SSD filesystem using UUID
  mount:
    path: "{{ data_ssd_mount_point }}"
    src: "UUID={{ ssd_uuid.stdout }}"
    fstype: "{{ data_ssd_filesystem }}"
    opts: "{{ data_ssd_mount_options | join(',') }}"
    state: mounted
  become: true

- name: Set ownership on mount point
  file:
    path: "{{ data_ssd_mount_point }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  become: true

- name: Verify mount is successful
  command: df -h {{ data_ssd_mount_point }}
  register: mount_status
  changed_when: false

- name: Display mount information
  debug:
    msg: "{{ mount_status.stdout_lines }}"