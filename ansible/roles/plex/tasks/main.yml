---
- name: Create Plex config directory
  file:
    path: "{{ docker_data_path }}/plex/config"
    state: directory
    owner: "{{ ansible_user }}"
    group: docker
    mode: '0755'

- name: Create Plex transcode directory
  file:
    path: "{{ docker_data_path }}/plex/transcode"
    state: directory
    owner: "{{ ansible_user }}"
    group: docker
    mode: '0755'


- name: Deploy Plex Media Server container
  docker_container:
    name: plex
    image: lscr.io/linuxserver/plex:latest
    state: started
    restart_policy: always
    recreate: true
    ports:
      - "{{ plex_port }}:32400"
      - "3005:3005"
      - "5353:5353/udp"
      - "8324:8324"
      - "32410:32410/udp"
      - "32412:32412/udp"
      - "32413:32413/udp"
      - "32414:32414/udp"
      - "32469:32469"
    env:
      PUID: "1000"
      PGID: "1000"
      TZ: "{{ timezone | default('UTC') }}"
      VERSION: docker
      PLEX_CLAIM: "{{ plex_claim_token | default('') }}"
    volumes:
      - "{{ docker_data_path }}/plex/config:/config"
      - "{{ docker_data_path }}/plex/transcode:/transcode"
      - "{{ docker_data_path }}/sabnzbd/downloads:/media"
      - /data/media/movies:/data/movies
      - /data/media/tv:/data/tv
      - "{{ docker_data_path }}/ytdl-sub:/ytdl-sub"
    networks:
      - name: homelab-network
    devices:
      - /dev/dri:/dev/dri  # For hardware transcoding if available

- name: Allow Plex through firewall (if ufw is enabled)
  ufw:
    rule: allow
    port: "{{ plex_port }}"
    proto: tcp
  when: enable_ufw | default(false)