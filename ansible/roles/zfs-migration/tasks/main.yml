---
- name: Check if migration is needed
  stat:
    path: "{{ migration_backup_path }}"
  register: migration_complete

- name: Check if source directory exists
  stat:
    path: "{{ migration_source_path }}"
  register: source_exists
  when: not migration_complete.stat.exists

- name: Skip migration if source doesn't exist
  debug:
    msg: "Source directory {{ migration_source_path }} does not exist, skipping migration"
  when: not migration_complete.stat.exists and not source_exists.stat.exists

- name: Get running containers
  shell: docker ps --format "{{.Names}}"
  register: running_containers
  when: not migration_complete.stat.exists and source_exists.stat.exists and migration_stop_containers
  changed_when: false

- name: Stop Docker containers gracefully
  shell: docker stop --time 30 {{ item }}
  loop: "{{ running_containers.stdout_lines }}"
  become: true
  when: not migration_complete.stat.exists and source_exists.stat.exists and migration_stop_containers and running_containers.stdout_lines | length > 0

- name: Verify containers stopped
  shell: docker ps -q
  register: remaining_containers
  failed_when: remaining_containers.stdout | length > 0
  when: not migration_complete.stat.exists and source_exists.stat.exists and migration_stop_containers
  changed_when: false

- name: Create temporary mount point
  file:
    path: "{{ zfs_migration_temp_mount }}"
    state: directory
  become: true
  when: not migration_complete.stat.exists and source_exists.stat.exists

- name: Set temporary mount point for migration
  zfs:
    name: "{{ zfs_docker_dataset }}"
    state: present
    extra_zfs_properties:
      mountpoint: "{{ zfs_migration_temp_mount }}"
  become: true
  when: not migration_complete.stat.exists and source_exists.stat.exists

- name: Get source directory size
  shell: du -sb {{ migration_source_path }} | cut -f1
  register: source_size
  when: not migration_complete.stat.exists and source_exists.stat.exists

- name: Display migration info
  debug:
    msg: 
      - "Migrating {{ migration_source_path }} to ZFS"
      - "Source size: {{ (source_size.stdout | int / 1024 / 1024 / 1024) | round(2) }} GB"
      - "Target: {{ zfs_migration_temp_mount }}"
  when: not migration_complete.stat.exists and source_exists.stat.exists

- name: Migration block with rollback on failure
  block:
    - name: Migrate data with rsync
      synchronize:
        src: "{{ migration_source_path }}/"
        dest: "{{ zfs_migration_temp_mount }}/"
        archive: yes
        checksum: yes
        delete: no
      become: true

    - name: Verify migration with simple file count check
      shell: |
        source_files=$(find {{ migration_source_path }} -type f | wc -l)
        target_files=$(find {{ zfs_migration_temp_mount }} -type f | wc -l)
        if [ "$source_files" != "$target_files" ]; then
          echo "File count mismatch: source=$source_files, target=$target_files"
          exit 1
        fi
        echo "File count verification passed: $source_files files"
      register: file_count_check
      when: zfs_verify_migration

    - name: Display verification results
      debug:
        msg: "{{ file_count_check.stdout }}"
      when: zfs_verify_migration

    - name: Backup original data
      command: mv {{ migration_source_path }} {{ migration_backup_path }}
      become: true

    - name: Set final ZFS mount point
      zfs:
        name: "{{ zfs_docker_dataset }}"
        state: present
        extra_zfs_properties:
          mountpoint: "{{ migration_target_path }}"
      become: true

    - name: Create symlink for backward compatibility
      file:
        src: "{{ migration_target_path }}"
        dest: "{{ migration_source_path }}"
        state: link
        force: yes
      become: true
      when: zfs_create_symlink

  rescue:
    - name: Migration failed - starting rollback
      debug:
        msg: "Migration failed, initiating rollback procedures"

    - name: Unmount ZFS dataset from temp location
      zfs:
        name: "{{ zfs_docker_dataset }}"
        state: present
        extra_zfs_properties:
          mountpoint: "none"
      become: true
      ignore_errors: true

    - name: Restore original directory if backup exists
      command: mv {{ migration_backup_path }} {{ migration_source_path }}
      become: true
      ignore_errors: true
      when: migration_backup_path is defined

    - name: Remove symlink if it was created
      file:
        path: "{{ migration_source_path }}"
        state: absent
      become: true
      ignore_errors: true
      when: zfs_create_symlink

    - name: Start containers after rollback
      shell: docker start {{ item }}
      loop: "{{ running_containers.stdout_lines }}"
      become: true
      when: running_containers.stdout_lines | length > 0
      ignore_errors: true

    - name: Fail the playbook after rollback
      fail:
        msg: "ZFS migration failed and has been rolled back"

  when: not migration_complete.stat.exists and source_exists.stat.exists


- name: Start Docker containers after migration
  shell: docker start {{ item }}
  loop: "{{ running_containers.stdout_lines }}"
  become: true
  when: not migration_complete.stat.exists and source_exists.stat.exists and migration_start_containers and running_containers.stdout_lines | length > 0
  register: container_start_results

- name: Verify containers started successfully
  shell: docker ps --filter "name={{ item }}" --format "{{.Names}}"
  loop: "{{ running_containers.stdout_lines }}"
  register: started_containers
  when: not migration_complete.stat.exists and source_exists.stat.exists and migration_start_containers and running_containers.stdout_lines | length > 0
  changed_when: false

- name: Display container start status
  debug:
    msg: "Successfully restarted {{ started_containers.results | selectattr('stdout', 'defined') | map(attribute='stdout') | list | length }} containers"
  when: not migration_complete.stat.exists and source_exists.stat.exists and migration_start_containers

- name: Display migration completion message
  debug:
    msg:
      - "Migration completed successfully!"
      - "Original data backed up to: {{ migration_backup_path }}"
      - "New ZFS dataset mounted at: {{ migration_target_path }}"
      - "Symlink created: {{ migration_source_path }} -> {{ migration_target_path }}"
  when: not migration_complete.stat.exists and source_exists.stat.exists

- name: Clean up temporary mount point
  file:
    path: "{{ zfs_migration_temp_mount }}"
    state: absent
  become: true
  when: not migration_complete.stat.exists and source_exists.stat.exists