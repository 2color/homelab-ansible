---
- name: Validate ZFS configuration
  assert:
    that:
      - zfs_pool_name is defined and zfs_pool_name | length > 0
      - zfs_pool_type is defined and zfs_pool_type in ['mirror', 'raidz', 'raidz2', 'raidz3', 'single']
      - zfs_pool_devices is defined and zfs_pool_devices | length > 0
      - zfs_pool_devices | select('match', '^/dev/') | list | length == zfs_pool_devices | length
      - zfs_pool_type != 'mirror' or zfs_pool_devices | length >= 2
      - zfs_datasets is defined
      - zfs_datasets | length == 0 or zfs_datasets | selectattr('name', 'undefined') | list | length == 0
      - zfs_datasets | length == 0 or zfs_datasets | selectattr('mountpoint', 'undefined') | list | length == 0
    fail_msg: "Invalid ZFS configuration detected. Check pool name, type, devices, and datasets."

- name: Install ZFS packages
  apt:
    name:
      - zfsutils-linux
      - zfs-dkms
    state: present
    update_cache: yes
  become: true

- name: Load ZFS kernel module
  modprobe:
    name: zfs
    state: present
  become: true

- name: Check if ZFS pool already exists
  command: zpool list {{ zfs_pool_name }}
  register: zfs_pool_exists
  failed_when: false
  changed_when: false
  become: true

- name: Verify all devices exist and are block devices
  stat:
    path: "{{ item }}"
    follow: true
  register: zfs_devices_stat
  failed_when: not zfs_devices_stat.stat.exists or not zfs_devices_stat.stat.isblk
  loop: "{{ zfs_pool_devices }}"
  when: zfs_pool_exists.rc != 0

- name: Check devices are not mounted or in use
  shell: lsblk -n -o MOUNTPOINT {{ item }} | grep -v '^$' || true
  register: devices_mounted
  failed_when: devices_mounted.stdout | trim | length > 0
  loop: "{{ zfs_pool_devices }}"
  when: zfs_pool_exists.rc != 0

- name: Check devices are not part of any existing ZFS pool
  shell: zpool status | grep -E "^\s+{{ item }}" || true
  register: devices_in_pool
  failed_when: devices_in_pool.stdout | trim | length > 0
  loop: "{{ zfs_pool_devices }}"
  become: true
  when: zfs_pool_exists.rc != 0

- name: Create ZFS pool with optimized properties
  command: >
    zpool create
    {% for key, value in zfs_pool_properties.items() %}-o {{ key }}={{ value }} {% endfor %}
    {% for key, value in zfs_default_properties.items() %}-O {{ key }}={{ value }} {% endfor %}
    {{ zfs_pool_name }}
    {% if zfs_pool_type != 'single' %}{{ zfs_pool_type }}{% endif %}
    {{ zfs_pool_devices | join(' ') }}
  become: true
  when: zfs_pool_exists.rc != 0

- name: Check if datasets exist
  shell: zfs list {{ item.name }}
  register: dataset_exists
  failed_when: false
  changed_when: false
  loop: "{{ zfs_datasets }}"

- name: Create missing ZFS datasets
  zfs:
    name: "{{ item.item.name }}"
    state: present
    extra_zfs_properties: "{{ zfs_default_properties | combine(item.item.properties) }}"
  become: true
  loop: "{{ dataset_exists.results }}"
  when: item.rc != 0

- name: Update ZFS dataset properties for existing datasets
  zfs:
    name: "{{ item.item.name }}"
    state: present
    extra_zfs_properties: "{{ zfs_default_properties | combine(item.item.properties) }}"
  become: true
  loop: "{{ dataset_exists.results }}"
  when: item.rc == 0

- name: Create ZFS import systemd service
  copy:
    dest: /etc/systemd/system/zfs-import.service
    content: |
      [Unit]
      Description=Import ZFS pools
      After=systemd-udev-settle.service
      Before=zfs-mount.service
      
      [Service]
      Type=oneshot
      ExecStart=/sbin/zpool import -a
      RemainAfterExit=yes
      
      [Install]
      WantedBy=multi-user.target
    mode: '0644'
  become: true
  notify: reload systemd

- name: Enable ZFS import service
  systemd:
    name: zfs-import
    enabled: yes
    daemon_reload: yes
  become: true

- name: Setup monthly ZFS scrub
  cron:
    name: "ZFS scrub {{ zfs_pool_name }}"
    cron_file: zfs-scrub
    user: root
    job: "/sbin/zpool scrub {{ zfs_pool_name }}"
    minute: "{{ zfs_scrub_cron_minute }}"
    hour: "{{ zfs_scrub_cron_hour }}"
    day: "{{ zfs_scrub_cron_day }}"
  become: true
  when: zfs_enable_scrub

- name: Set ownership on ZFS pool mountpoint
  file:
    path: "/backup-data"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  become: true

- name: Display ZFS status
  command: zpool status {{ zfs_pool_name }}
  register: zfs_status
  changed_when: false

- name: Show ZFS pool information
  debug:
    msg: "{{ zfs_status.stdout_lines }}"